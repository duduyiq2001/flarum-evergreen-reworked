/*! For license information please see forum.js.LICENSE.txt */
(()=>{var t={887:t=>{!function(){var e=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"],n="undefined"!=typeof window,o=n&&null!=window.mozInnerScreenX;function r(t,r,i){if(!n)throw new Error("textarea-caret-position#getCaretCoordinates should only be called in a browser");var s=i&&i.debug||!1;if(s){var a=document.querySelector("#input-textarea-caret-position-mirror-div");a&&a.parentNode.removeChild(a)}var c=document.createElement("div");c.id="input-textarea-caret-position-mirror-div",document.body.appendChild(c);var u=c.style,p=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle,f="INPUT"===t.nodeName;u.whiteSpace="pre-wrap",f||(u.wordWrap="break-word"),u.position="absolute",s||(u.visibility="hidden"),e.forEach((function(t){f&&"lineHeight"===t?u.lineHeight=p.height:u[t]=p[t]})),o?t.scrollHeight>parseInt(p.height)&&(u.overflowY="scroll"):u.overflow="hidden",c.textContent=t.value.substring(0,r),f&&(c.textContent=c.textContent.replace(/\s/g," "));var l=document.createElement("span");l.textContent=t.value.substring(r)||".",c.appendChild(l);var d={top:l.offsetTop+parseInt(p.borderTopWidth),left:l.offsetLeft+parseInt(p.borderLeftWidth),height:parseInt(p.lineHeight)};return s?l.style.backgroundColor="#aaa":document.body.removeChild(c),d}void 0!==t.exports?t.exports=r:n&&(window.getCaretCoordinates=r)}()},648:(t,e,n)=>{var o=n(288).default;function r(){"use strict";t.exports=r=function(){return n},t.exports.__esModule=!0,t.exports.default=t.exports;var e,n={},i=Object.prototype,s=i.hasOwnProperty,a=Object.defineProperty||function(t,e,n){t[e]=n.value},c="function"==typeof Symbol?Symbol:{},u=c.iterator||"@@iterator",p=c.asyncIterator||"@@asyncIterator",f=c.toStringTag||"@@toStringTag";function l(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{l({},"")}catch(e){l=function(t,e,n){return t[e]=n}}function d(t,e,n,o){var r=e&&e.prototype instanceof b?e:b,i=Object.create(r.prototype),s=new B(o||[]);return a(i,"_invoke",{value:L(t,n,s)}),i}function h(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}n.wrap=d;var m="suspendedStart",v="suspendedYield",y="executing",g="completed",w={};function b(){}function x(){}function P(){}var T={};l(T,u,(function(){return this}));var C=Object.getPrototypeOf,_=C&&C(C(N([])));_&&_!==i&&s.call(_,u)&&(T=_);var $=P.prototype=b.prototype=Object.create(T);function S(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function k(t,e){function n(r,i,a,c){var u=h(t[r],t,i);if("throw"!==u.type){var p=u.arg,f=p.value;return f&&"object"==o(f)&&s.call(f,"__await")?e.resolve(f.__await).then((function(t){n("next",t,a,c)}),(function(t){n("throw",t,a,c)})):e.resolve(f).then((function(t){p.value=t,a(p)}),(function(t){return n("throw",t,a,c)}))}c(u.arg)}var r;a(this,"_invoke",{value:function(t,o){function i(){return new e((function(e,r){n(t,o,e,r)}))}return r=r?r.then(i,i):i()}})}function L(t,n,o){var r=m;return function(i,s){if(r===y)throw new Error("Generator is already running");if(r===g){if("throw"===i)throw s;return{value:e,done:!0}}for(o.method=i,o.arg=s;;){var a=o.delegate;if(a){var c=E(a,o);if(c){if(c===w)continue;return c}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(r===m)throw r=g,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);r=y;var u=h(t,n,o);if("normal"===u.type){if(r=o.done?g:v,u.arg===w)continue;return{value:u.arg,done:o.done}}"throw"===u.type&&(r=g,o.method="throw",o.arg=u.arg)}}}function E(t,n){var o=n.method,r=t.iterator[o];if(r===e)return n.delegate=null,"throw"===o&&t.iterator.return&&(n.method="return",n.arg=e,E(t,n),"throw"===n.method)||"return"!==o&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+o+"' method")),w;var i=h(r,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,w;var s=i.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,w):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,w)}function M(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function j(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function B(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(M,this),this.reset(!0)}function N(t){if(t||""===t){var n=t[u];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,i=function n(){for(;++r<t.length;)if(s.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(o(t)+" is not iterable")}return x.prototype=P,a($,"constructor",{value:P,configurable:!0}),a(P,"constructor",{value:x,configurable:!0}),x.displayName=l(P,f,"GeneratorFunction"),n.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===x||"GeneratorFunction"===(e.displayName||e.name))},n.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,P):(t.__proto__=P,l(t,f,"GeneratorFunction")),t.prototype=Object.create($),t},n.awrap=function(t){return{__await:t}},S(k.prototype),l(k.prototype,p,(function(){return this})),n.AsyncIterator=k,n.async=function(t,e,o,r,i){void 0===i&&(i=Promise);var s=new k(d(t,e,o,r),i);return n.isGeneratorFunction(e)?s:s.next().then((function(t){return t.done?t.value:s.next()}))},S($),l($,f,"Generator"),l($,u,(function(){return this})),l($,"toString",(function(){return"[object Generator]"})),n.keys=function(t){var e=Object(t),n=[];for(var o in e)n.push(o);return n.reverse(),function t(){for(;n.length;){var o=n.pop();if(o in e)return t.value=o,t.done=!1,t}return t.done=!0,t}},n.values=N,B.prototype={constructor:B,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(j),!t)for(var n in this)"t"===n.charAt(0)&&s.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(o,r){return a.type="throw",a.arg=t,n.next=o,r&&(n.method="next",n.arg=e),!!r}for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r],a=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=s.call(i,"catchLoc"),u=s.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&s.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var r=o;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=e&&e<=r.finallyLoc&&(r=null);var i=r?r.completion:{};return i.type=t,i.arg=e,r?(this.method="next",this.next=r.finallyLoc,w):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),w},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),j(n),w}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var o=n.completion;if("throw"===o.type){var r=o.arg;j(n)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,o){return this.delegate={iterator:N(t),resultName:n,nextLoc:o},"next"===this.method&&(this.arg=e),w}},n}t.exports=r,t.exports.__esModule=!0,t.exports.default=t.exports},288:t=>{function e(n){return t.exports=e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t.exports.__esModule=!0,t.exports.default=t.exports,e(n)}t.exports=e,t.exports.__esModule=!0,t.exports.default=t.exports},357:(t,e,n)=>{var o=n(648)();t.exports=o;try{regeneratorRuntime=o}catch(t){"object"==typeof globalThis?globalThis.regeneratorRuntime=o:Function("r","regeneratorRuntime = r")(o)}}},e={};function n(o){var r=e[o];if(void 0!==r)return r.exports;var i=e[o]={exports:{}};return t[o](i,i.exports,n),i.exports}n.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},n.d=(t,e)=>{for(var o in e)n.o(e,o)&&!n.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var o={};(()=>{"use strict";n.r(o),n.d(o,{filterPostMentions:()=>St,filterUserMentions:()=>$t});const t=flarum.core.compat.app;var e=n.n(t);const r=flarum.core.compat.extend,i=flarum.core.compat["utils/DiscussionControls"];var s=n.n(i);flarum.core.compat["components/Alert"];const a=flarum.core.compat["components/Button"];var c=n.n(a);const u=flarum.core.compat["components/CommentPost"];var p=n.n(u);const f=flarum.core.compat["models/Post"];var l=n.n(f);const d=flarum.core.compat.Model;var h=n.n(d);const v=flarum.core.compat["components/ReplyComposer"];var y=n.n(v);const g=flarum.core.compat["components/LogInModal"];var w=n.n(g);const b=flarum.core.compat["components/NotificationGrid"];var x=n.n(b);const P=flarum.core.compat["utils/string"],T=flarum.core.compat["components/PostPreview"];var C=n.n(T);const _=flarum.core.compat["components/LoadingIndicator"];var S=n.n(_);const k=flarum.core.compat["components/Link"];var L=n.n(k);const E=flarum.core.compat["helpers/punctuateSeries"];var M=n.n(E);const j=flarum.core.compat["helpers/username"];var B=n.n(j);const N=flarum.core.compat["helpers/icon"];var O=n.n(N);function A(t,e,n,o,r,i,s){try{var a=t[i](s),c=a.value}catch(t){return void n(t)}a.done?e(c):Promise.resolve(c).then(o,r)}function I(t){return function(){var e=this,n=arguments;return new Promise((function(o,r){var i=t.apply(e,n);function s(t){A(i,o,r,s,a,"next",t)}function a(t){A(i,o,r,s,a,"throw",t)}s(void 0)}))}}var W=n(357),H=n.n(W);const R=flarum.core.compat["components/EditPostComposer"];var D=n.n(R);function q(t,e,n){var o=t.user(),r="@"+(o?o.username():t.number())+"#"+t.id()+" ";e.fields.content()||(e.body.attrs.originalContent=r);var i=e.editor.getSelectionRange()[0],s=e.fields.content().slice(0,i),a=0==s.length?0:3-s.match(/(\n{0,2})$/)[0].length;e.editor.insertAtCursor(Array(a).join("\n")+(n?"> "+r+n.trim().replace(/\n/g,"\n> ")+"\n\n":r))}function z(t,e){return U.apply(this,arguments)}function U(){return(U=I(H().mark((function t(e,n){var o;return H().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!app.composer.bodyMatches(D())||app.composer.body.attrs.post.discussion()!==e.discussion()){t.next=4;break}q(e,app.composer,n),t.next=8;break;case 4:return o=e.id(),e.replyTo()>0&&(o=e.replyTo()),t.next=8,s().replyAction.call(e.discussion(),!1,!1,o).then((function(t){return q(e,t,n)}));case 8:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function G(t,e){return G=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},G(t,e)}function F(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,G(t,e)}const J=flarum.core.compat["utils/extract"];var Y=n.n(J),X=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.view=function(){var e=this,n=Y()(this.attrs,"post"),o=Y()(this.attrs,"content");return this.attrs.className="Button PostQuoteButton",this.attrs.icon="fas fa-quote-left",this.attrs.children=app.translator.trans("flarum-mentions.forum.post.quote_button"),this.attrs.onclick=function(){e.hide(),z(n,o)},this.attrs.onmousedown=function(t){return t.stopPropagation()},t.prototype.view.call(this)},n.config=function(t){t||$(document).on("mousedown",this.hide.bind(this))},n.show=function(t,e){var n=this.$().show(),o=n.offsetParent().offset();n.css("left",t-o.left).css("top",e-o.top)},n.showStart=function(t,e){var n=this.$();this.show(t,$(window).scrollTop()+e-n.outerHeight()-5)},n.showEnd=function(t,e){var n=this.$();this.show(t-n.outerWidth(),$(window).scrollTop()+e+5)},n.hide=function(){this.$().hide()},e}(c());var K=n(887),V=n.n(K);const Q=flarum.core.compat["components/ComposerBody"];var Z=n.n(Q);const tt=flarum.core.compat["components/TextEditor"];var et=n.n(tt);const nt=flarum.core.compat["components/TextEditorButton"];var ot=n.n(nt);const rt=flarum.core.compat["helpers/avatar"];var it=n.n(rt);const st=flarum.core.compat["helpers/highlight"];var at=n.n(st);const ct=flarum.core.compat["utils/KeyboardNavigatable"];var ut=n.n(ct);const pt=flarum.core.compat.Component;var ft=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.init=function(){this.active=!1,this.index=0,this.keyWasJustPressed=!1},n.view=function(){return m("ul",{className:"Dropdown-menu MentionsDropdown"},this.attrs.items.map((function(t){return m("li",null,t)})))},n.show=function(t,e){this.$().show().css({left:t+"px",top:e+"px"}),this.active=!0},n.hide=function(){this.$().hide(),this.active=!1},n.navigate=function(t){var e=this;this.keyWasJustPressed=!0,this.setIndex(this.index+t,!0),clearTimeout(this.keyWasJustPressedTimeout),this.keyWasJustPressedTimeout=setTimeout((function(){return e.keyWasJustPressed=!1}),500)},n.complete=function(){this.$("li").eq(this.index).find("button").click()},n.setIndex=function(t,e){if(!this.keyWasJustPressed||e){var n=this.$(),o=n.find("li"),r=t;r<0?r=o.length-1:r>=o.length&&(r=0),this.index=r;var i=o.removeClass("active").eq(r).addClass("active");if(e){var s,a=n.scrollTop(),c=n.offset().top,u=c+n.outerHeight(),p=i.offset().top,f=p+i.outerHeight();p<c?s=a-c+p-parseInt(n.css("padding-top"),10):f>u&&(s=a-u+f+parseInt(n.css("padding-bottom"),10)),void 0!==s&&n.stop(!0).animate({scrollTop:s},100)}}},e}(n.n(pt)());const lt=flarum.core.compat["components/Notification"];var dt=n.n(lt),ht=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.icon=function(){return"fas fa-reply"},n.href=function(){var t=this.attrs.notification,e=t.subject(),n=t.content();return app.route.discussion(e.discussion(),n&&n.replyNumber)},n.content=function(){var t=this.attrs.notification.fromUser();return app.translator.transChoice("flarum-mentions.forum.notifications.post_mentioned_text",1,{user:t})},n.excerpt=function(){return(0,P.truncate)(this.attrs.notification.subject().contentPlain(),200)},e}(dt()),mt=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.icon=function(){return"fas fa-at"},n.href=function(){var t=this.attrs.notification.subject();return app.route.discussion(t.discussion(),t.number())},n.content=function(){var t=this.attrs.notification.fromUser();return app.translator.trans("flarum-mentions.forum.notifications.user_mentioned_text",{user:t})},n.excerpt=function(){return(0,P.truncate)(this.attrs.notification.subject().contentPlain(),200)},e}(dt());const vt=flarum.core.compat["components/UserPage"];var yt=n.n(vt);const gt=flarum.core.compat["components/LinkButton"];var wt=n.n(gt);const bt=flarum.core.compat["components/PostsUserPage"];var xt=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.prototype.loadResults=function(t){return app.store.find("posts",{filter:{type:"comment",mentioned:this.user.id()},page:{offset:t,limit:this.loadLimit},sort:"-createdAt"})},e}(n.n(bt)());const Pt=flarum.core.compat["components/Post"];var Tt=n.n(Pt);const Ct=flarum.core.compat["utils/extractText"];var _t=n.n(Ct);function $t(t){var e=app.store.getBy("users","username",t.getAttribute("username"));if(e)return t.setAttribute("id",e.id()),t.setAttribute("displayname",_t()(B()(e))),!0}function St(t){var e=app.store.getById("posts",t.getAttribute("id"));if(e)return t.setAttribute("discussionid",e.discussion().id()),t.setAttribute("number",e.number()),t.setAttribute("displayname",_t()(B()(e.user()))),!0}e().initializers.add("kyrne-everygreen",(function(){l().prototype.replyTo=h().attribute("replyTo"),l().prototype.replyCount=h().attribute("replyCount"),s().replyAction=function(t,n,o){var r=this;return new Promise((function(i,s){return e().session.user?r.canReply()?(e().composer.composingReplyTo(r)&&!n||e().composer.load(y(),{user:e().session.user,discussion:r,replyTo:o}),e().composer.show(),t&&e().viewingDiscussion(r)&&!e().composer.isFullScreen()&&e().current.get("stream").goToNumber("reply"),i(e().composer)):s():(e().modal.show(w()),s())}))},(0,r.extend)(y().prototype,"oninit",(function(){this.replyTo=this.attrs.replyTo})),(0,r.extend)(y().prototype,"data",(function(t){t.replyTo=this.replyTo})),(0,r.override)(y().prototype,"onsubmit",(function(){var t=this,n=this.attrs.discussion;this.loading=!0,m.redraw();var o=this.data();e().store.createRecord("posts").save(o).then((function(o){if(t.draft&&t.draft.delete(),e().viewingDiscussion(n)){var r=e().current.get("stream");r.update().then((function(){r.goToNumber(o.number()),console.log("uuuuu"),m.redraw().sync()}))}else{var i,s=c().component({className:"Button Button--link",onclick:function(){m.route.set(e().route.post(o)),e().alerts.dismiss(i)}},e().translator.trans("core.forum.composer_reply.view_button"));i=e().alerts.show({type:"success",controls:[s]},e().translator.trans("core.forum.composer_reply.posted_message"))}e().composer.hide()}),this.loaded.bind(this))})),function(){function t(){var t=this.attrs.post.contentHtml();if(t!==this.oldPostContentHtml&&!this.isEditing()){this.oldPostContentHtml=t;var e=this.attrs.post,n=this.$();this.$().on("click",".UserMention:not(.UserMention--deleted), .PostMention:not(.PostMention--deleted)",(function(t){m.route.set(this.getAttribute("href")),t.preventDefault()})),this.$(".PostMention:not(.PostMention--deleted)").each((function(){var t,o=$(this),r=o.data("id"),i=$('<ul class="Dropdown-menu PostMention-preview fade"/>');n.append(i);var s=function(){return $('.PostStream-item[data-id="'+r+'"]')},a=function(){var t=s(),a=!1;if(t.length){var c=t.offset().top,u=window.pageYOffset;c>u&&c+t.height()<u+$(window).height()&&(t.addClass("pulsate"),a=!0)}if(!a){var p=function(){var t=i.outerHeight(!0),e=0;o.offset().top-t<$(window).scrollTop()+$("#header").outerHeight()?e+=o.outerHeight(!0):e-=t,i.show().css("top",o.offset().top-n.offset().top+e).css("left",o.offsetParent().offset().left-n.offset().left).css("max-width",o.offsetParent().width())},f=function(t){var n=t.discussion();m.render(i[0],[n!==e.discussion()?m("li",null,m("span",{className:"PostMention-preview-discussion"},n.title())):"",m("li",null,C().component({post:t}))]),p()},l=app.store.getById("posts",r);l&&l.discussion()?f(l):(m.render(i[0],S().component()),app.store.find("posts",r).then(f),p()),setTimeout((function(){return i.off("transitionend").addClass("in")}))}},c=function(){s().removeClass("pulsate"),i.hasClass("in")&&i.removeClass("in").one("transitionend",(function(){return i.hide()}))};o.on("touchend",(function(t){t.cancelable&&t.preventDefault()})),o.add(i).hover((function(){clearTimeout(t),t=setTimeout(a,250)}),(function(){clearTimeout(t),s().removeClass("pulsate"),t=setTimeout(c,250)})).on("touchend",(function(t){a(),t.stopPropagation()})),$(document).on("touchend",c)}))}}(0,r.extend)(p().prototype,"oncreate",t),(0,r.extend)(p().prototype,"onupdate",t)}(),function(){function t(){this.$(".Post-mentionedBy-preview").removeClass("in").one("transitionend",(function(){$(this).hide()}))}l().prototype.mentionedBy=h().hasMany("mentionedBy"),(0,r.extend)(p().prototype,"oncreate",(function(){var e,n=this,o=this.attrs.post.mentionedBy();if(o&&o.length){var r=$('<ul class="Dropdown-menu Post-mentionedBy-preview fade"/>');this.$().append(r);var i=this.$(),s=this.$(".Post-mentionedBy"),a=function(){!r.hasClass("in")&&r.is(":visible")||(m.render(r[0],o.map((function(e){return m("li",{"data-number":e.number()},C().component({post:e,onclick:t.bind(n)}))}))),r.show().css("top",s.offset().top-i.offset().top+s.outerHeight(!0)).css("left",s.offsetParent().offset().left-i.offset().left).css("max-width",i.width()),setTimeout((function(){return r.off("transitionend").addClass("in")})))};s.add(r).hover((function(){clearTimeout(e),e=setTimeout(a,250)}),(function(){clearTimeout(e),e=setTimeout(t,250)})),this.$().find(".Post-mentionedBy-summary a").hover((function(){r.find('[data-number="'+$(this).data("number")+'"]').addClass("active")}),(function(){r.find("[data-number]").removeClass("active")}))}})),(0,r.extend)(p().prototype,"footerItems",(function(e){var n=this,o=this.attrs.post.mentionedBy();if(o&&o.length){var r=[],i=o.sort((function(t){return t.user()===app.session.user?-1:0})).filter((function(t){var e=t.user();if(-1===r.indexOf(e))return r.push(e),!0})),s=i.length>4,a=i.slice(0,s?3:4).map((function(e){var o=e.user();return m(L(),{href:app.route.post(e),onclick:t.bind(n),"data-number":e.number()},app.session.user===o?app.translator.trans("flarum-mentions.forum.post.you_text"):B()(o))}));if(s){var c=i.length-a.length;a.push(app.translator.trans("flarum-mentions.forum.post.others_text",{count:c}))}e.add("replies",m("div",{className:"Post-mentionedBy"},m("span",{className:"Post-mentionedBy-summary"},O()("fas fa-reply"),app.translator.trans("flarum-mentions.forum.post.mentioned_by"+(i[0].user()===app.session.user?"_self":"")+"_text",{count:a.length,users:M()(a)}))))}}))}(),(0,r.extend)(p().prototype,"actionItems",(function(t){var e=this.attrs.post;e.isHidden()||app.session.user&&!e.discussion().canReply()||t.add("reply",m(c(),{className:"Button Button--link",onclick:I(H().mark((function t(){return H().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,z(e);case 2:console.log("redrawing"),m.redraw();case 4:case"end":return t.stop()}}),t)})))},app.translator.trans("flarum-mentions.forum.post.reply_link")))})),(0,r.extend)(p().prototype,"config",(function(t,e){var n=this.attrs.post;if(!(e||n.isHidden()||app.session.user&&!n.discussion().canReply())){var o=this.$(".Post-body"),r=$('<div class="Post-quoteButtonContainer"></div>'),i=function(t){setTimeout((function(){var e=function(t){var e=window.getSelection();if(e.rangeCount){var n=e.getRangeAt(0),o=n.commonAncestorContainer;if(t[0]===o||$.contains(t[0],o)){var r=$("<div>").append(n.cloneContents());return r.find("img.emoji").replaceWith((function(){return this.alt})),r.find("img").replaceWith((function(){return"![]("+this.src+")"})),r.find("a").replaceWith((function(){return"["+this.innerText+"]("+this.href+")"})),r.text()}}return""}(o);if(e){var i=new X({post:n,content:e});m.render(r[0],i.render());var s=window.getSelection().getRangeAt(0).getClientRects(),a=s[0];if(t.clientY<a.bottom&&t.clientX-a.right<a.left-t.clientX)i.showStart(a.left,a.top);else{var c=s[s.length-1];i.showEnd(c.right,c.bottom)}}}),1)};this.$().after(r).on("mouseup",i),"ontouchstart"in window&&document.addEventListener("selectionchange",i,!1)}})),(0,r.extend)(Z().prototype,"config",(function(t,e){if(!e){var n,o,r,i=this,s=$('<div class="ComposerBody-mentionsDropdownContainer"></div>'),a=new ft({items:[]}),c=this.$("textarea").wrap('<div class="ComposerBody-mentionsWrapper"></div>'),u=[];this.navigator=new(ut()),this.navigator.when((function(){return a.active})).onUp((function(){return a.navigate(-1)})).onDown((function(){return a.navigate(1)})).onSelect(a.complete.bind(a)).onCancel(a.hide.bind(a)).bindTo(c),c.after(s).on("click keyup input",(function(t){var e=this;if(-1===[9,13,27,40,38,37,39].indexOf(t.which)){var p=this.selectionStart;if(!(this.selectionEnd-p>0)){var f=this.value;n=0;for(var l=p-1;l>=p-30;l--)if("@"===f.substr(l,1)){n=l+1;break}if(a.hide(),a.active=!1,n){o=f.substring(n,p).toLowerCase();var d=function(t,e,r,s){void 0===s&&(s="");var u=B()(t);return console.log("here!!!"),console.log(u),o&&(u.children[0]=at()(u.children[0],o)),m("button",{className:"PostPreview "+s,onclick:function(){return function(t){var e=t+" ",o=n-1+e.length,r=i.content();i.editor.setValue(r.substring(0,n-1)+e+r.substr(c[0].selectionStart)),i.editor.setSelectionRange(o,o),a.hide()}(e)},onmouseenter:function(){a.setIndex($(this).parent().index())}},m("span",{className:"PostPreview-content"},it()(t),u," ",r))},h=function(t){return[t.username(),t.displayName()].some((function(t){return t.toLowerCase().substr(0,o.length)===o}))},v=function(){var t=[];o&&app.store.all("users").forEach((function(e){h(e)&&t.push(d(e,"@"+e.username(),"","MentionsDropdown-user"))}));var r=i.attrs.post,c=r&&r.discussion()||i.attrs.discussion;if(c&&c.posts().filter((function(t){return t&&"comment"===t.contentType()&&(!r||t.number()<r.number())})).sort((function(t,e){return e.createdAt()-t.createdAt()})).filter((function(t){var e=t.user();return e&&h(e)})).splice(0,5).forEach((function(e){var n=e.user();t.push(d(n,"@"+n.username()+"#"+e.id(),[app.translator.trans("flarum-mentions.forum.composer.reply_to_post_text",{number:e.number()})," — ",(0,P.truncate)(e.contentPlain(),200)],"MentionsDropdown-post"))})),t.length){a.attrs.items=t,m.render(s[0],a.render()),a.show();var u=V()(e,n),p=a.$().outerWidth(),f=a.$().outerHeight(),l=a.$().offsetParent(),v=u.left,y=u.top-e.scrollTop+15;y+f>l.height()&&(y=u.top-e.scrollTop-f-15),v+p>l.width()&&(v=l.width()-p),a.show(v,y)}else a.active=!1,a.hide()};a.active=!0,v(),a.setIndex(0),a.$().scrollTop(0),clearTimeout(r),o&&(r=setTimeout((function(){var t=o.toLowerCase();-1===u.indexOf(t)&&(app.store.find("users",{filter:{q:o},page:{limit:5}}).then((function(){a.active&&v()})),u.push(t))}),250))}}}}))}})),(0,r.extend)(et().prototype,"toolbarItems",(function(t){var e=this;t.add("mention",m(ot(),{onclick:function(){return e.insertAtCursor("@")},icon:"fas fa-at"},app.translator.trans("flarum-mentions.forum.composer.mention_tooltip")))})),(0,r.override)(Tt().prototype,"config",(function(){this.$(".Post-actions"),this.$(".Post-controls").on("click tap",(function(){$(this).toggleClass("open")}))})),(0,r.extend)(Tt().prototype,"oncreate",(function(t){var e=this,n=this.attrs.post.id(),o="discussion,user,user.groups,hiddenUser,editedUser,";app.initializers.has("fof-gamification")&&(o+="user.ranks,upvotes,"),app.initializers.has("fof/reactions")&&(o+="reactions"),app.alerts.clear(),app.store.find("trees",n,{include:o.replace(/,\s*$/,"")}).then((function(t){e.uniquePosts=t.filter((function(t,e,n){return n.findIndex((function(e){return e.id()===t.id()}))===e})).sort((function(t,e){return t.createdAt()-e.createdAt()})).map((function(t){return p().component({post:t})})),m.redraw()}))})),(0,r.extend)(Tt().prototype,"view",(function(t){var e=this.attrs.post.id();app.cache.trees||(app.cache.trees={},app.cache.pushTree={}),app.cache.trees[e]||(app.cache.trees[e]=[],app.cache.pushTree[e]=0),app.initializers.has("fof-gamification")&&(include+="user.ranks,upvotes,"),app.initializers.has("fof/reactions")&&(include+="reactions"),this.uniquePosts&&t.children.push(m("div",{className:"CommentTree",id:e},O()("fas fa-reply"),this.uniquePosts))})),e().notificationComponents.postMentioned=ht,e().notificationComponents.userMentioned=mt,(0,r.extend)(x().prototype,"notificationTypes",(function(t){t.add("postMentioned",{name:"postMentioned",icon:"fas fa-reply",label:e().translator.trans("flarum-mentions.forum.settings.notify_post_mentioned_label")}),t.add("userMentioned",{name:"userMentioned",icon:"fas fa-at",label:e().translator.trans("flarum-mentions.forum.settings.notify_user_mentioned_label")})})),e().routes["user.mentions"]={path:"/u/:username/mentions",component:xt},(0,r.extend)(yt().prototype,"navItems",(function(t){var n=this.user;t.add("mentions",wt().component({href:e().route("user.mentions",{username:n.slug()}),name:"mentions",icon:"fas fa-at"},e().translator.trans("flarum-mentions.forum.user.mentions_link")),80)})),P.getPlainContent.removeSelectors.push("a.PostMention")})),(0,r.extend)(l().prototype,"oninit",(function(){this.uniqueKey=Date.now()})),(0,r.extend)(l().prototype,"forceRerender",(function(){this.uniqueKey=Date.now(),m.redraw()})),(0,r.extend)(l().prototype,"onbeforeupdate",(function(t,e){return!0}))})(),module.exports=o})();
//# sourceMappingURL=forum.js.map